

## OAuth Integration Plan (Google + Apple Sign-In)

### Problem Being Solved

The previous OAuth attempt failed with 404 errors because it used `supabase.auth.signInWithOAuth()` directly. On Lovable Cloud with custom domains like `logactually.com`, the OAuth callback URL must be proxied through Lovable's managed authentication system.

**The fix**: Use the `@lovable.dev/cloud-auth-js` package and `lovable.auth.signInWithOAuth()` instead of the Supabase client directly. This handles the OAuth proxy automatically for both Google and Apple.

---

### Implementation Steps

#### Step 1: Configure Social Auth (Tool Call)

Use the `configure-social-auth` tool which:
- Generates the `src/integrations/lovable/` folder with the managed auth client
- Installs the `@lovable.dev/cloud-auth-js` package
- Sets up the proper OAuth proxy configuration for both providers

#### Step 2: Update Auth.tsx with OAuth + New Button Layout

**Current Layout:**
```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [Sign In] button                    â”‚
â”‚                                      â”‚
â”‚  Don't have an account? Sign Up      â”‚
â”‚  Or try the demo â€” no account needed â”‚
â”‚                                      â”‚
â”‚  Privacy & Security                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**New Layout (Sign In mode):**
```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [Sign In] button                    â”‚
â”‚                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ or â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚
â”‚                                      â”‚
â”‚  [G] Continue with Google            â”‚
â”‚  [ðŸŽ] Sign in with Apple             â”‚
â”‚  [âœ‰] Sign up with email              â”‚
â”‚                                      â”‚
â”‚  Or try the demo â€” no account needed â”‚
â”‚                                      â”‚
â”‚  Privacy & Security                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**New Layout (Sign Up mode):**
```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Email field                         â”‚
â”‚  Password field                      â”‚
â”‚  Confirm Password field              â”‚
â”‚                                      â”‚
â”‚  [Sign Up] button                    â”‚
â”‚                                      â”‚
â”‚  Already have an account? Sign In    â”‚
â”‚                                      â”‚
â”‚  Privacy & Security                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Button Text (Branding Requirements)

| Provider | Button Text | Reason |
|----------|-------------|--------|
| Google | "Continue with Google" | Google allows flexibility |
| Apple | "Sign in with Apple" | **Required** by Apple Human Interface Guidelines |
| Email | "Sign up with email" | Standard phrasing for non-OAuth option |

---

### Files to Modify

| File | Change |
|------|--------|
| `src/integrations/lovable/` | Auto-generated by configure-social-auth tool |
| `src/pages/Auth.tsx` | Add OAuth buttons, divider, "Sign up with email" button, and handler functions |

---

### Code Changes to Auth.tsx

**1. Add imports:**
```typescript
import { lovable } from "@/integrations/lovable/index";
import { Mail } from "lucide-react";
```

**2. Add new state variables:**
```typescript
const [isGoogleLoading, setIsGoogleLoading] = useState(false);
const [isAppleLoading, setIsAppleLoading] = useState(false);
```

**3. Add OAuth handler functions:**
```typescript
const handleGoogleSignIn = async () => {
  setIsGoogleLoading(true);
  setErrorMessage(null);
  
  const { error } = await lovable.auth.signInWithOAuth("google", {
    redirect_uri: window.location.origin,
  });
  
  if (error) {
    setErrorMessage("Google sign-in failed. Please try again.");
    setIsGoogleLoading(false);
  }
};

const handleAppleSignIn = async () => {
  setIsAppleLoading(true);
  setErrorMessage(null);
  
  const { error } = await lovable.auth.signInWithOAuth("apple", {
    redirect_uri: window.location.origin,
  });
  
  if (error) {
    setErrorMessage("Apple sign-in failed. Please try again.");
    setIsAppleLoading(false);
  }
};
```

**4. Update the button section (replacing lines 297-311):**

In Sign In mode (`!isSignUp`), after the Sign In button:
```tsx
{/* Divider */}
<div className="relative py-4">
  <div className="absolute inset-0 flex items-center">
    <span className="w-full border-t" />
  </div>
  <div className="relative flex justify-center text-xs uppercase">
    <span className="bg-background px-2 text-muted-foreground">or</span>
  </div>
</div>

{/* OAuth and Email Sign Up buttons */}
<div className="space-y-2">
  {/* Google */}
  <Button
    type="button"
    variant="outline"
    className="w-full"
    onClick={handleGoogleSignIn}
    disabled={submitting || isGoogleLoading || isAppleLoading || isDemoLoading}
  >
    {isGoogleLoading ? (
      "Signing in..."
    ) : (
      <>
        <svg className="mr-2 h-4 w-4" viewBox="0 0 24 24">
          {/* Google G logo SVG paths */}
        </svg>
        Continue with Google
      </>
    )}
  </Button>

  {/* Apple */}
  <Button
    type="button"
    variant="outline"
    className="w-full"
    onClick={handleAppleSignIn}
    disabled={submitting || isGoogleLoading || isAppleLoading || isDemoLoading}
  >
    {isAppleLoading ? (
      "Signing in..."
    ) : (
      <>
        <svg className="mr-2 h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
          {/* Apple logo SVG path */}
        </svg>
        Sign in with Apple
      </>
    )}
  </Button>

  {/* Email Sign Up */}
  <Button
    type="button"
    variant="outline"
    className="w-full"
    onClick={() => {
      setIsSignUp(true);
      setErrorMessage(null);
    }}
    disabled={submitting || isGoogleLoading || isAppleLoading || isDemoLoading}
  >
    <Mail className="mr-2 h-4 w-4" />
    Sign up with email
  </Button>
</div>

{/* Demo link */}
<p className="text-center text-sm text-muted-foreground">
  Or{" "}
  <button
    type="button"
    onClick={handleTryDemo}
    disabled={submitting || isDemoLoading || isGoogleLoading || isAppleLoading}
    className="text-blue-500 underline-offset-4 hover:underline disabled:opacity-50"
  >
    {isDemoLoading ? "loading demo..." : "try the demo"}
  </button>{" "}
  â€” no account needed
</p>
```

In Sign Up mode (`isSignUp`), after the Sign Up button:
```tsx
<p className="text-center text-sm text-muted-foreground">
  Already have an account?{" "}
  <button
    type="button"
    onClick={() => {
      setIsSignUp(false);
      setConfirmPassword("");
      setErrorMessage(null);
    }}
    className="text-primary underline-offset-4 hover:underline"
  >
    Sign In
  </button>
</p>
```

---

### What Changes

| Element | Before | After |
|---------|--------|-------|
| Sign up link | Text link "Don't have an account? Sign Up" | Outline button "Sign up with email" with Mail icon |
| OAuth buttons | None | Two new buttons: Google and Apple |
| Divider | None | "or" divider between form and buttons |
| Sign up mode | Shows OAuth area | Hides OAuth buttons, shows "Already have an account?" text link |

---

### What Stays Exactly the Same

- Email/password form fields
- Sign In / Sign Up button (primary action)
- Password reset flow
- Demo button functionality (just moved slightly)
- Privacy & Security link
- All loading states and error handling for email auth
- Card layout, logo, title, description
- Password update flow (reset callback)

---

### Why This Won't 404

The `@lovable.dev/cloud-auth-js` package routes OAuth through Lovable's managed infrastructure:

1. User clicks "Continue with Google" or "Sign in with Apple"
2. `lovable.auth.signInWithOAuth()` redirects to Lovable's OAuth proxy
3. Proxy handles the OAuth flow with the respective provider
4. User is redirected back to `window.location.origin` (works with custom domains)
5. Session is established via the existing Supabase auth listener in `useAuth.tsx`

This avoids the 404 errors because the callback URL is managed by Lovable rather than pointing directly to a Supabase endpoint that doesn't exist on custom domains.

---

### Technical Notes

- Both Google and Apple are supported by Lovable Cloud's managed OAuth
- No API keys needed from the user - Lovable manages the OAuth credentials
- The existing `useAuth.tsx` auth state listener will automatically pick up the session after OAuth redirect
- Loading states disable all auth buttons to prevent race conditions
- The Mail icon comes from lucide-react (already installed)
- Google logo uses the official colored SVG
- Apple logo uses a simple black SVG that works with the outline button style

